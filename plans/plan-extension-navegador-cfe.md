[["Sistema de Facturaci\u00f3n del Estado] -->|Descarga PDF| B[Extensi\u00f3n del Navegador]\n    B -->|Detecta descarga| C{\u00bfEs CFE v\u00e1lido?}\n    C -->|S\u00ed| D[Env\u00eda PDF a API Laravel]\n    C -->|No| E[Ignora descarga]\n    D --> F[API Laravel - Endpoint /api/cfe/procesar]\n    F --> G[Servicio de Procesamiento de CFEs]\n    G --> H[Detector de Tipo de CFE]\n    H --> I{\u00bfTipo de CFE?}\n    I -->|Certificado Residencia| J[Extraer datos espec\u00edficos]\n    I -->|Multas Cobradas| K[Extraer datos espec\u00edficos]\n    I -->|Porte Armas| L[Extraer datos espec\u00edficos]\n    I -->|Tenencia Armas| M[Extraer datos espec\u00edficos]\n    J --> N[Guardar en tabla pendientes]\n    K --> N\n    L --> N\n    M --> N\n    N --> O[Notificar usuario]\n    O --> P[Componente de Revisi\u00f3n]\n    P --> Q{\u00bfUsuario confirma?}\n    Q -->|S\u00ed| R[Guardar en tabla definitiva]\n    Q -->|No| S[Eliminar registro pendiente]\n    R --> T[Actualizar estado del certificado]\n```\n\n## Componentes de la Soluci\u00f3n\n\n### 1. API REST en Laravel\n\n#### 1.1 Endpoint para recibir PDFs\n\n- **Ruta**: `POST /api/cfe/procesar`\n- **Autenticaci\u00f3n**: API Token o Sanctum\n- **Par\u00e1metros**:\n  - `pdf_file`: Archivo PDF (multipart/form-data)\n  - `source_url`: URL de origen (opcional, para verificar que viene del sistema de facturaci\u00f3n)\n  - `user_id`: ID del usuario que realiz\u00f3 la descarga (opcional)\n\n#### 1.2 Endpoint para consultar CFEs pendientes\n\n- **Ruta**: `GET /api/cfe/pendientes`\n- **Respuesta**: Lista de CFEs pendientes de confirmaci\u00f3n\n\n#### 1.3 Endpoint para confirmar CFE\n\n- **Ruta**: `POST /api/cfe/{id}/confirmar`\n- **Par\u00e1metros**:\n  - `datos_modificados`: Datos que el usuario haya modificado (opcional)\n\n#### 1.4 Endpoint para rechazar CFE\n\n- **Ruta**: `POST /api/cfe/{id}/rechazar`\n- **Par\u00e1metros**:\n  - `motivo`: Motivo del rechazo (opcional)\n\n### 2. Servicio de Procesamiento de CFEs\n\n#### 2.1 Clase: `CfeProcessorService`\n\n**Responsabilidades**:\n- Recibir el PDF y extraer el texto usando `SmalotPdfParserParser`\n- Detectar el tipo de CFE bas\u00e1ndose en palabras clave\n- Extraer datos espec\u00edficos seg\u00fan el tipo de CFE\n- Validar la consistencia de los datos extra\u00eddos\n- Guardar el registro en la tabla de pendientes\n\n**M\u00e9todos**:\n```php\nclass CfeProcessorService\n{\n    public function procesarPdf(UploadedFile $pdf, ?string $sourceUrl = null, ?int $userId = null): CfePendiente\n    public function detectarTipoCfe(string $texto): string\n    public function extraerDatosCertificadoResidencia(string $texto): array\n    public function extraerDatosMultasCobradas(string $texto): array\n    public function extraerDatosPorteArmas(string $texto): array\n    public function extraerDatosTenenciaArmas(string $texto): array\n    public function validarDatos(array $datos, string $tipoCfe): bool\n}\n```\n\n#### 2.2 Detector de Tipo de CFE\n\n**Palabras clave por tipo**:\n- **Certificado de Residencia**: \"CERTIFICADO DE RESIDENCIA", "CERTIFICADO RESIDENCIA\"\n- **Multas Cobradas**: \"MULTA", "INFRACCI\u00d3N", "TR\u00c1NSITO\"\n- **Porte de Armas**: \"PORTE", "ARMA", "PORTAR\"\n- **Tenencia de Armas**: \"TENENCIA", "TAHTA", "POSI\u00d3N", 3.0, "Base de Datos\n\n#### 3.1 Nueva tabla: `tes_cfe_pendientes`\n\n```php\nSchema::create('tes_cfe_pendientes', function (Blueprint $table) {\n    $table->id();\n    $table->enum('tipo_cfe', ['certificado_residencia', 'multas_cobradas', 'porte_armas', 'tenencia_armas', 'desconocido']);\n    $table->string('serie')->nullable();\n    $table->string('numero')->nullable();\n    $table->date('fecha')->nullable();\n    $table->decimal('monto', 10, 2)->nullable();\n    $table->string('moneda', 3)->default('UYU');\n    $table->json('datos_extraidos'); // Datos extra\u00eddos del PDF\n    $table->string('pdf_path')->nullable(); // Ruta del PDF almacenado\n    $table->string('source_url')->nullable(); // URL de origen\n    $table->enum('estado', ['pendiente', 'confirmado', 'rechazado', 'procesado'])->default('pendiente');\n    $table->text('motivo_rechazo')->nullable();\n    $table->integer('user_id')->unsigned()->nullable(); // Usuario que descarg\u00f3 el PDF\n    $table->integer('procesado_por')->unsigned()->nullable(); // Usuario que confirm\u00f3/rechaz\u00f3\n    $table->timestamp('procesado_at')->nullable();\n    $table->timestamps();\n    $table->softDeletes();\n\n    $table->foreign('user_id')->references('id')->on('users');\n    $table->foreign('procesado_por')->references('id')->on('users');\n    \n    $table->index(['tipo_cfe', 'estado']);\n    $table->index(['serie', 'numero', 'fecha']);\n});\n```\n\n### 4. Componente Livewire para Revisi\u00f3n\n\n#### 4.1 Clase: `CfePendientesIndex`\n\n**Responsabilidades**:\n- Mostrar lista de CFEs pendientes de confirmaci\u00f3n\n- Permitir ver detalles de cada CFE\n- Permitir confirmar o rechazar cada CFE\n- Mostrar notificaciones cuando hay CFEs pendientes\n\n**M\u00e9todos**:\n```php\nclass CfePendientesIndex extends Component\n{\n    public $cfePendientes;\n    public $cfeSeleccionado;\n    public $datosModificados = [];\n\n    public function mount(): void\n    public function verDetalles(int $id): void\n    public function confirmarCfe(int $id): void\n    public function rechazarCfe(int $id, string $motivo = null): void\n    public function getListeners(): array\n}\n```\n\n#### 4.2 Vista: `cfe-pendientes-index.blade.php`\n\n**Elementos**:\n- Tabla con CFEs pendientes\n- Modal para ver detalles del CFE\n- Formulario para modificar datos antes de confirmar\n- Botones para confirmar o rechazar\n- Indicador de notificaciones (badge con cantidad de pendientes)\n\n### 5. Extensi\u00f3n del Navegador\n\n#### 5.1 Estructura de la Extensi\u00f3n\n\n```\nextension-cfe-detect/\n\u251c\u2500\u2500 manifest.json\n\u251c\u2500\u2500 background.js\n\u251c\u2500\u2500 content.js\n\u251c\u2500\u2500 popup/\n\u2502   \u251c\u2500\u2500 popup.html\n\u2502   \u251c\u2500\u2500 popup.js\n\u2502   \u2514\u2500\u2500 popup.css\n\u251c\u2500\u2500 icons/\n\u2502   \u251c\u2500\u2500 icon16.png\n\u2502   \u251c\u2500\u2500 icon48.png\n\u2502   \u2514\u2500\u2500 icon128.png\n\u2514\u2500\u2500 options/\n    \u251c\u2500\u2500 options.html\n    \u251c\u2500\u2500 options.js\n    \u2514\u2500\u2500 options.css\n```\n\n#### 5.2 Archivo: `manifest.json`\n\n```json\n{\n  \"manifest_version", 3, "name\": \"Detector de CFEs - Tesorer\u00eda", "version\": \"1.0.0", "description\": \"Detecta autom\u00e1ticamente CFEs descargados del sistema de facturaci\u00f3n del estado", "permissions\": [\n    \"downloads", "storage", "activeTab", "notifications"], ["https://*.gub.uy/*", "http://localhost/*"], {"service_worker": "background.js"}, {"default_popup": "popup/popup.html", "default_icon": {"16": "icons/icon16.png", "48": "icons/icon48.png", "128": "icons/icon128.png"}}, {"16": "icons/icon16.png", "48": "icons/icon48.png", "128": "icons/icon128.png"}, {"apiEndpoint": "http://localhost:8000/api/cfe/procesar", "apiToken": "", "allowedDomains": ["facturacion.gub.uy", "efactura.gub.uy"]}, {"pendingDownload": "downloadItem.id"}, {"complete') {\n    chrome.storage.local.get(['pendingDownload'], (result) => {\n      if (result.pendingDownload === delta.id) {\n        processDownload(delta.id);\n        chrome.storage.local.remove(['pendingDownload": ""}, {"method": "POST", "headers": {"Authorization": "Bearer ${config.apiToken"}, "body": "formData"}, {"El CFE ha sido enviado a la tesorer\u00eda": ""}, {"No se pudo enviar el CFE a la tesorer\u00eda": ""}, {"descarga": ", error);\n    showNotification('Error", "Ocurri\u00f3 un error al procesar el archivo": ""}, {"arraybuffer';\n    xhr.onload = () => resolve(xhr.response);\n    xhr.onerror = () => reject(new Error('Error al leer el archivo": "xhr.send();"}, {"type": "basic", "iconUrl": "icons/icon128.png", "title": "title", "message": "message"}, {"tipo' => 'cfe_pendiente',\n            'titulo' => 'Nuevo CFE pendiente de confirmaci\u00f3n',\n            'mensaje' => 'Se ha detectado un CFE de ' . $this->cfePendiente->tipo_cfe . ' pendiente de confirmaci\u00f3n',\n            'cfe_id": "this->cfePendiente->id\n        ];"}, ["Crear migraci\u00f3n de tabla `tes_cfe_pendientes`\n- [ ] Crear modelo `CfePendiente`\n- [ ] Crear servicio `CfeProcessorService`\n- [ ] Implementar detector de tipo de CFE\n- [ ] Implementar extractores de datos por tipo\n- [ ] Crear endpoints de la API REST\n- [ ] Implementar sistema de colas\n- [ ] Crear job `ProcesarCfeJob`\n\n### Fase 2: Frontend Livewire (Semanas 4-5)\n\n- [ ] Crear componente `CfePendientesIndex`\n- [ ] Crear vista `cfe-pendientes-index.blade.php`\n- [ ] Implementar sistema de notificaciones\n- [ ] Agregar badge de notificaciones en el men\u00fa\n- [ ] Implementar eventos en tiempo real\n\n### Fase 3: Extensi\u00f3n del Navegador (Semanas 6-7)\n\n- [ ] Crear estructura de la extensi\u00f3n\n- [ ] Implementar `manifest.json`\n- [ ] Implementar `background.js`\n- [ ] Implementar detector de descargas\n- [ ] Implementar comunicaci\u00f3n con API Laravel\n- [ ] Crear popup de configuraci\u00f3n\n- [ ] Crear p\u00e1gina de opciones\n- [ ] Implementar notificaciones\n\n### Fase 4: Integraci\u00f3n y Pruebas (Semanas 8-9)\n\n- [ ] Realizar pruebas unitarias\n- [ ] Realizar pruebas de integraci\u00f3n\n- [ ] Realizar pruebas end-to-end\n- [ ] Realizar pruebas de usuario\n- [ ] Corregir bugs encontrados\n- [ ] Optimizar rendimiento\n\n### Fase 5: Documentaci\u00f3n y Despliegue (Semana 10)\n\n- [ ] Crear documentaci\u00f3n de instalaci\u00f3n\n- [ ] Crear documentaci\u00f3n de configuraci\u00f3n\n- [ ] Crear manual de usuario\n- [ ] Desplegar en producci\u00f3n\n- [ ] Capacitar a los usuarios\n\n## Recursos Necesarios\n\n### 1. Recursos de Desarrollo\n\n- **Backend Laravel**: 1 desarrollador (3 semanas)\n- **Frontend Livewire**: 1 desarrollador (2 semanas)\n- **Extensi\u00f3n del Navegador**: 1 desarrollador (2 semanas)\n- **Integraci\u00f3n y Pruebas**: 1 desarrollador (2 semanas)\n- **Documentaci\u00f3n**: 1 desarrollador (1 semana)\n\n### 2. Recursos de Infraestructura\n\n- **Servidor de Desarrollo**: Servidor existente\n- **Servidor de Producci\u00f3n**: Servidor existente\n- **Storage para PDFs**: Espacio adicional en el storage existente\n- **Sistema de Colas**: Redis o Beanstalkd (ya configurado)\n\n### 3. Herramientas y Librer\u00edas\n\n- **Laravel**: Versi\u00f3n actual del proyecto\n- **Smalot/PdfParser**: Ya instalado\n- **Livewire**: Ya instalado\n- **Chrome Extension API**: Para desarrollo de la extensi\u00f3n\n- **Firefox WebExtensions API**: Para compatibilidad con Firefox\n\n## Riesgos y Mitigaci\u00f3n\n\n### 1. Riesgo: La extensi\u00f3n no detecte todas las descargas\n\n**Mitigaci\u00f3n**:\n- Implementar m\u00faltiples m\u00e9todos de detecci\u00f3n\n- Permitir configuraci\u00f3n manual de dominios\n- Probar extensivamente con diferentes navegadores\n\n### 2. Riesgo: El procesamiento de PDFs falle\n\n**Mitigaci\u00f3n**:\n- Implementar manejo robusto de errores\n- Permitir reintentos autom\u00e1ticos\n- Notificar al usuario cuando falle el procesamiento\n\n### 3. Riesgo: Los datos extra\u00eddos sean incorrectos\n\n**Mitigaci\u00f3n**:\n- Implementar validaciones estrictas\n- Permitir que el usuario modifique los datos antes de confirmar\n- Implementar sistema de aprendizaje para mejorar la extracci\u00f3n\n\n### 4. Riesgo: Problemas de seguridad\n\n**Mitigaci\u00f3n**:\n- Implementar autenticaci\u00f3n robusta\n- Validar todos los datos de entrada\n- Implementar auditor\u00eda completa\n- Realizar pruebas de seguridad\n\n## M\u00e9tricas de \u00c9xito\n\n### 1. M\u00e9tricas Funcionales\n\n- **Porcentaje de CFEs detectados**: > 95%\n- **Porcentaje de extracciones correctas**: > 90%\n- **Tiempo de procesamiento**: < 30 segundos\n- **Porcentaje de confirmaciones exitosas**: > 95%\n\n### 2. M\u00e9tricas de Usabilidad\n\n- **Satisfacci\u00f3n del usuario**: > 4/5\n- **Tiempo para confirmar un CFE**: < 2 minutos\n- **Porcentaje de usuarios que usan la extensi\u00f3n**: > 80%\n\n### 3. M\u00e9tricas de Impacto\n\n- **Reducci\u00f3n de errores de registro**: > 80%\n- **Reducci\u00f3n de tiempo de registro**: > 50%\n- **Mejora en la consistencia de datos**: > 90%\n\n## Conclusi\u00f3n\n\nEsta soluci\u00f3n proporciona una forma automatizada y eficiente de detectar y procesar CFEs descargados del sistema de facturaci\u00f3n del estado, reduciendo significativamente el error humano y mejorando la consistencia de los datos en el sistema de tesorer\u00eda.\n\nLa implementaci\u00f3n se divide en fases claras y manejables, con un enfoque en la seguridad, usabilidad y mantenibilidad del sistema."]]
